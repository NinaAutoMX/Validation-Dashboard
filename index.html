<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Validation Report</title>
  <link rel="icon" type="image/png" href="https://copilot.microsoft.com/th/id/BCO.5f34131a-d4f6-472e-94d0-cdd1c38d89f0.png">
  <style>
    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f8f9fa;
      --bg-section: rgba(255,255,255,0.95);
      --text-primary: #1a1a1a;
      --text-secondary: #4e125f;
      --border-color: #e0e0e0;
      --shadow: rgba(0,0,0,0.1);
      --accent: #6a1a7f;
      --accent-hover: #4e125f;
      --input-bg: rgba(255,255,255,0.9);
      --success: #27ae60;
      --warning: #e67e22;
      --danger: #c0392b;
    }

    [data-theme="dark"] {
      --bg-primary: #1a1a1a;
      --bg-secondary: #2c2c2c;
      --bg-section: rgba(40,40,40,0.95);
      --text-primary: #e0e0e0;
      --text-secondary: #b896d4;
      --border-color: #404040;
      --shadow: rgba(0,0,0,0.3);
      --accent: #8e5ea2;
      --accent-hover: #b896d4;
      --input-bg: rgba(50,50,50,0.9);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, Arial, sans-serif;
      color: var(--text-primary);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      transition: all 0.3s ease;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: var(--bg-primary);
      border-radius: 16px;
      box-shadow: 0 20px 60px var(--shadow);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
      padding: 30px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
      position: relative;
    }

    .header-content {
      display: flex;
      align-items: center;
      gap: 30px;
      flex: 1;
    }

    .header h1 {
      font-size: 2em;
      font-weight: 600;
      margin: 0;
    }

    .autobody-input-wrapper {
      flex: 1;
      max-width: 400px;
    }

    .autobody-input-wrapper label {
      display: block;
      font-size: 0.85em;
      margin-bottom: 8px;
      opacity: 0.9;
    }

    .autobody-input-wrapper input {
      width: 100%;
      padding: 10px 15px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 8px;
      background: rgba(255,255,255,0.15);
      color: white;
      font-size: 1em;
      transition: all 0.3s ease;
    }

    .autobody-input-wrapper input::placeholder {
      color: rgba(255,255,255,0.6);
    }

    .autobody-input-wrapper input:focus {
      outline: none;
      background: rgba(255,255,255,0.25);
      border-color: rgba(255,255,255,0.6);
    }

    .theme-toggle {
      background: rgba(255,255,255,0.2);
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50px;
      padding: 8px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
      color: white;
      font-size: 0.9em;
    }

    .theme-toggle:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
    }

    .content {
      padding: 40px;
    }

    .section {
      background: var(--bg-section);
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 8px var(--shadow);
      transition: all 0.3s ease;
    }

    .section:hover {
      box-shadow: 0 4px 16px var(--shadow);
    }

    .section-title {
      font-size: 1.3em;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--accent);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title::before {
      content: "‚óè";
      color: var(--accent);
    }

    .input-grid {
      display: grid;
      gap: 20px;
    }

    .input-group {
      display: grid;
      grid-template-columns: 180px 1fr;
      gap: 15px;
      align-items: center;
    }

    .input-pair {
      display: grid;
      grid-template-columns: 180px 1fr 180px 1fr;
      gap: 15px;
      align-items: center;
    }

    .input-full {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 25px;
    }

    label {
      font-weight: 500;
      color: var(--text-primary);
      font-size: 0.95em;
    }

    input[type="number"],
    input[type="text"],
    input[type="date"],
    textarea {
      padding: 12px 16px;
      font-size: 14px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      background: var(--input-bg);
      color: var(--text-primary);
      transition: all 0.3s ease;
      font-family: inherit;
    }

    input:hover,
    textarea:hover {
      border-color: var(--accent);
    }

    input:focus,
    textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(106, 26, 127, 0.1);
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 15px 25px;
      align-items: center;
    }

    .checkbox-group label {
      display: flex;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }

    .checkbox-group input[type="checkbox"] {
      margin-right: 8px;
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--accent);
    }

    .disclaimer-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 25px;
    }

    fieldset {
      border: 2px solid var(--border-color);
      border-radius: 10px;
      padding: 20px;
      background: var(--bg-secondary);
      transition: all 0.3s ease;
    }

    fieldset:hover {
      border-color: var(--accent);
    }

    legend {
      font-weight: 600;
      color: var(--accent);
      padding: 0 10px;
      font-size: 0.95em;
    }

    .button-container {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin: 40px 0 20px;
      flex-wrap: wrap;
    }

    button {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 14px 32px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px var(--shadow);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px var(--shadow);
    }

    button:active {
      transform: translateY(0);
    }

    .new-report-btn {
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    }

    .autosave-indicator {
      text-align: center;
      color: var(--success);
      font-size: 0.9em;
      font-style: italic;
      padding: 15px;
      background: var(--bg-section);
      border-radius: 8px;
      margin-top: 10px;
      border: 1px solid var(--border-color);
    }

    #output {
      background: var(--bg-section);
      border: 2px solid var(--accent);
      border-left: 6px solid var(--accent);
      padding: 30px;
      font-size: 15px;
      line-height: 1.8;
      margin-top: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 16px var(--shadow);
    }

    #reportText {
      white-space: pre-wrap;
      word-break: break-word;
    }

    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 20px;
      }

      .header-content {
        flex-direction: column;
        width: 100%;
      }

      .autobody-input-wrapper {
        max-width: 100%;
      }

      .input-pair,
      .input-full,
      .input-group {
        grid-template-columns: 1fr;
      }

      .content {
        padding: 20px;
      }

      .section {
        padding: 20px;
      }

      .button-container {
        flex-direction: column;
      }

      button {
        width: 100%;
      }
    }

    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="container fade-in">
    <div class="header">
      <div class="header-content">
        <h1>Validation Report</h1>
        <div class="autobody-input-wrapper">
          <label for="autobodyName">Autobody Name</label>
          <input type="text" id="autobodyName" placeholder="Enter autobody name...">
        </div>
      </div>
      <button class="theme-toggle" onclick="toggleTheme()">
        <span id="themeIcon">üåô</span>
        <span id="themeText">Dark Mode</span>
      </button>
    </div>

    <div class="content">
      <!-- Section: Repair Totals -->
      <div class="section">
        <h3 class="section-title">Repair Totals</h3>
        <div class="input-group" style="margin-bottom: 20px;">
          <label><input type="checkbox" id="chkLastSubmitted"> Data last submitted:</label>
          <input type="date" id="lastSubmittedDate">
        </div>
        <div class="input-grid">
          <div class="input-pair">
            <label for="activeRepairs">Active Repairs:</label>
            <input type="number" id="activeRepairs">
            <label for="approvedActive">Approved Brand ‚Äì Active:</label>
            <input type="number" id="approvedActive">
          </div>
          <div class="input-pair">
            <label for="completed2025">Completed Repairs 2025:</label>
            <input type="number" id="completed2025">
            <label for="approved2025">Approved Brand ‚Äì 2025:</label>
            <input type="number" id="approved2025">
          </div>
          <div class="input-pair">
            <label for="completed2024">Completed Repairs 2024:</label>
            <input type="number" id="completed2024">
            <label for="approved2024">Approved Brand ‚Äì 2024:</label>
            <input type="number" id="approved2024">
          </div>
          <div class="input-group">
            <label for="exclusive2024">2024 Repairs (Excl. Earlier):</label>
            <input type="number" id="exclusive2024">
          </div>
          <div class="input-pair">
            <label for="completed2023">Completed Repairs 2023:</label>
            <input type="number" id="completed2023">
            <label for="completed2022">Completed Repairs 2022:</label>
            <input type="number" id="completed2022">
          </div>
          <div class="input-pair">
            <label for="writeOffs">Write-offs (total):</label>
            <input type="number" id="writeOffs">
            <label for="writeOffsUnder40k">Write-offs < R40 000:</label>
            <input type="number" id="writeOffsUnder40k">
          </div>
          <div class="input-pair">
            <label for="pp2025">PP 2025:</label>
            <input type="number" id="pp2025">
            <label for="pp2024">PP 2024:</label>
            <input type="number" id="pp2024">
          </div>
          <div class="input-pair">
            <label for="tsp">TSP:</label>
            <input type="number" id="tsp" placeholder="e.g. 1234567.89">
            <label for="invalidJobs">Invalid Jobs:</label>
            <input type="number" id="invalidJobs">
          </div>
        </div>
        <div class="input-full" style="margin-top: 20px;">
          <div class="input-group">
            <label for="openLong">Open >100 Days:</label>
            <input type="number" id="openLong" placeholder="e.g. 186">
          </div>
          <div class="input-group">
            <label for="openLongApproved">Approved Brand ‚Äì Open >100 Days:</label>
            <input type="number" id="openLongApproved" placeholder="e.g. 20">
          </div>
        </div>
      </div>

      <!-- Section: Aggregate Flags -->
      <div class="section">
        <h3 class="section-title">Aggregate Data Submission</h3>
        <div class="input-grid">
          <div class="checkbox-group">
            <label><input type="checkbox" id="chkAggregateMake"> Submitting aggregate data</label>
            <label><input type="checkbox" name="aggregateMakeOption" value="Including"> Including</label>
            <label><input type="checkbox" name="aggregateMakeOption" value="Excluding"> Excluding</label>
            <label><input type="checkbox" id="chkFullBrandData"> Submitting full data for approved brands</label>
            <label><input type="checkbox" id="chkAggregateText"> Receiving aggregate data for some repairs</label>
            <label><input type="checkbox" id="chkInsurerName"> Not submitting Insurer Name</label>
          </div>
          <div class="input-group">
            <label for="aggregateTextBrands">Brands receiving aggregate data:</label>
            <input type="text" id="aggregateTextBrands" placeholder="e.g. Ford, Hyundai, Mahindra">
          </div>
        </div>
      </div>

      <!-- Section: Missing Field Summary -->
      <div class="section">
        <h3 class="section-title">Missing Field Summary</h3>
        <div class="input-grid">
          <div class="input-group">
            <label for="missstart">Missing Start Date:</label>
            <input type="number" id="missstart">
          </div>
          <div class="input-group">
            <label for="compldatemiss">Missing Compl. Date:</label>
            <input type="number" id="compldatemiss">
          </div>
          <div class="input-group">
            <label for="make">Missing Make:</label>
            <input type="number" id="make">
          </div>
          <div class="input-full">
            <div class="input-group">
              <label for="validModel">Missing Valid Model:</label>
              <input type="number" id="validModel">
            </div>
            <div class="checkbox-group">
              <label><input type="checkbox" name="validModels" value="Chery Tiggo"> Chery Tiggo</label>
              <label><input type="checkbox" name="validModels" value="Chery Omoda"> Chery Omoda</label>
              <label><input type="checkbox" name="validModels" value="GWM Steed"> GWM Steed</label>
              <label><input type="checkbox" name="validModels" value="Mahindra Scorpio"> Mahindra Scorpio</label>
              <label><input type="checkbox" name="validModels" value="Mahindra XUV"> Mahindra XUV</label>
            </div>
          </div>
          <div class="input-group">
            <label for="hasRegno">Missing Registration No:</label>
            <input type="number" id="hasRegno">
          </div>
          <div class="input-group">
            <label for="missingVIN">Missing VIN:</label>
            <input type="number" id="missingVIN">
          </div>
          <div class="input-pair">
            <label for="missReg">Missing Year of Registration:</label>
            <input type="number" id="missReg">
            <label for="missRegActive">Active:</label>
            <input type="number" id="missRegActive">
          </div>
          <div class="input-group">
            <label for="missRegUnknownWarranty">Unknown Warranty Status:</label>
            <input type="number" id="missRegUnknownWarranty">
          </div>
          <div class="input-pair">
            <label for="mileage">Missing Mileage:</label>
            <input type="number" id="mileage">
            <label for="mileageActive">Active:</label>
            <input type="number" id="mileageActive">
          </div>
          <div class="input-group">
            <label for="ownerName">Missing Owner Name:</label>
            <input type="number" id="ownerName">
          </div>
          <div class="input-group">
            <label for="ownerTel">Missing Owner Tel:</label>
            <input type="number" id="ownerTel">
          </div>
          <div class="input-group">
            <label for="fullQuote">Missing Full Quote Details:</label>
            <input type="number" id="fullQuote">
          </div>
          <div class="input-group">
            <label for="partDescription">Missing Part Description:</label>
            <input type="number" id="partDescription">
          </div>
          <div class="input-group">
            <label for="missingSupplier">Missing Supplier Name:</label>
            <input type="number" id="missingSupplier">
          </div>
          <div class="input-pair">
            <label for="spotSample">Spot-checked repairs:</label>
            <input type="number" id="spotSample">
            <label for="flaggedParts">Flagged:</label>
            <input type="number" id="flaggedParts">
          </div>
          <div class="input-group">
            <label for="ppp">Missing Part Purchase Price:</label>
            <input type="number" id="ppp">
          </div>
          <div class="input-group">
            <label for="ppSpotCheckFlagged">Flagged repairs from PP spot-check:</label>
            <input type="number" id="ppSpotCheckFlagged">
          </div>
          <div class="input-group">
            <label for="pp2025JobsInput">PP 2025 Job Details:</label>
            <textarea id="pp2025JobsInput" placeholder="e.g. PP123 - Brake pad - 01/01/2025"></textarea>
          </div>
        </div>
      </div>

      <!-- Section: Disclaimers -->
      <div class="section">
        <h3 class="section-title">Disclaimer Forms</h3>
        <div class="disclaimer-grid">
          <fieldset>
            <legend>Ford 08/11/2024</legend>
            <label><input type="checkbox" id="fordDisclaimerCheck"> No recent In & Out of Warranty with non-OEM parts</label>
            <textarea id="fordDisclaimer"></textarea>
          </fieldset>
          <fieldset>
            <legend>GWM & Haval 19/08/2025</legend>
            <label><input type="checkbox" id="gwmhavalDisclaimerCheck"> No recent In-Warranty with non-OEM parts</label>
            <textarea id="gwmhavalDisclaimer"></textarea>
          </fieldset>
          <fieldset>
            <legend>Honda 17/01/2025</legend>
            <label><input type="checkbox" id="hondaDisclaimerCheck"> No recent In-Warranty with non-OEM parts</label>
            <textarea id="hondaDisclaimer"></textarea>
          </fieldset>
          <fieldset>
            <legend>Hyundai 01/04/2025</legend>
            <label><input type="checkbox" id="hyundaiDisclaimerCheck"> No recent In-Warranty with non-OEM parts</label>
            <textarea id="hyundaiDisclaimer"></textarea>
          </fieldset>
          <fieldset>
            <legend>Isuzu 21/05/2025</legend>
            <label><input type="checkbox" id="isuzuDisclaimerCheck"> No recent In-Warranty with non-OEM parts</label>
            <textarea id="isuzuDisclaimer"></textarea>
          </fieldset>
          <fieldset>
            <legend>JAC 27/06/2025</legend>
            <label><input type="checkbox" id="jacDisclaimerCheck"> No recent In-Warranty with non-OEM parts</label>
            <textarea id="jacDisclaimer"></textarea>
          </fieldset>
          <fieldset>
            <legend>Mahindra 22/07/2025</legend>
            <label><input type="checkbox" id="mahindraDisclaimerCheck"> No recent In-Warranty with non-OEM parts</label>
            <textarea id="mahindraDisclaimer"></textarea>
          </fieldset>
          <fieldset>
            <legend>Mitsubishi 28/03/2025</legend>
            <label><input type="checkbox" id="mitsubishiDisclaimerCheck"> No recent In-Warranty with non-OEM parts</label>
            <textarea id="mitsubishiDisclaimer"></textarea>
          </fieldset>
          <fieldset>
            <legend>Suzuki 09/06/2025</legend>
            <label><input type="checkbox" id="suzukiDisclaimerCheck"> No recent In-Warranty with non-OEM parts</label>
            <textarea id="suzukiDisclaimer"></textarea>
          </fieldset>
          <fieldset>
            <legend>Stellantis Categorization Forms 18/11/2024</legend>
            <label><input type="checkbox" id="stellantisDisclaimerCheck"> No recent categorization forms</label>
            <textarea id="stellantisDisclaimer"></textarea>
          </fieldset>
        </div>
      </div>

      <!-- Section: Notes & Creator -->
      <div class="section">
        <h3 class="section-title">Final Notes</h3>
        <div class="input-grid">
          <div class="input-group">
            <label for="additionalNotes">Additional Notes:</label>
            <textarea id="additionalNotes" placeholder="Any extra context or observations..."></textarea>
          </div>
          <div class="checkbox-group">
            <label>Created By:</label>
            <label><input type="checkbox" name="creator" value="NH" onclick="toggleExclusive(this)"> (NH)</label>
            <label><input type="checkbox" name="creator" value="JW" onclick="toggleExclusive(this)"> (JW)</label>
          </div>
        </div>
      </div>

      <div class="button-container">
        <button onclick="generateReport()">Generate Report</button>
        <button class="new-report-btn" onclick="newReport()">Generate New Report</button>
      </div>
      <div class="autosave-indicator" id="autosaveIndicator">Auto-save enabled - Your work is saved automatically</div>

      <div id="output">
        <div id="reportText"></div>
      </div>
    </div>
  </div>

  <script>
    // Theme toggle
    function toggleTheme() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      html.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      
      const icon = document.getElementById('themeIcon');
      const text = document.getElementById('themeText');
      
      if (newTheme === 'dark') {
        icon.textContent = '‚òÄÔ∏è';
        text.textContent = 'Light Mode';
      } else {
        icon.textContent = 'üåô';
        text.textContent = 'Dark Mode';
      }
    }

    // Load saved theme
    function loadTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      
      const icon = document.getElementById('themeIcon');
      const text = document.getElementById('themeText');
      
      if (savedTheme === 'dark') {
        icon.textContent = '‚òÄÔ∏è';
        text.textContent = 'Light Mode';
      }
    }

    // Auto-save functionality
    let autosaveTimeout;
    const AUTOSAVE_DELAY = 1000;

    function saveFormData() {
      const formData = {};
      
      document.querySelectorAll('input[type="number"], input[type="text"], input[type="date"], textarea').forEach(input => {
        if (input.id) {
          formData[input.id] = input.value;
        }
      });
      
      document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        if (checkbox.id) {
          formData[checkbox.id] = checkbox.checked;
        }
        if (checkbox.name) {
          if (!formData[checkbox.name]) {
            formData[checkbox.name] = [];
          }
          if (checkbox.checked) {
            formData[checkbox.name].push(checkbox.value);
          }
        }
      });
      
      localStorage.setItem('repairDashboardData', JSON.stringify(formData));
      
      const indicator = document.getElementById('autosaveIndicator');
      indicator.textContent = 'Auto-saved ‚úì';
      indicator.style.color = 'var(--success)';
      
      setTimeout(() => {
        indicator.textContent = 'Auto-save enabled - Your work is saved automatically';
        indicator.style.color = 'var(--accent)';
      }, 2000);
    }

    function loadFormData() {
      const savedData = localStorage.getItem('repairDashboardData');
      if (!savedData) return;
      
      const formData = JSON.parse(savedData);
      
      Object.keys(formData).forEach(key => {
        const element = document.getElementById(key);
        if (element && (element.type === 'number' || element.type === 'text' || element.type === 'date' || element.tagName === 'TEXTAREA')) {
          element.value = formData[key];
        } else if (element && element.type === 'checkbox') {
          element.checked = formData[key];
        }
      });
      
      document.querySelectorAll('input[type="checkbox"][name]').forEach(checkbox => {
        if (formData[checkbox.name] && Array.isArray(formData[checkbox.name])) {
          checkbox.checked = formData[checkbox.name].includes(checkbox.value);
        }
      });
    }

    function autoSave() {
      clearTimeout(autosaveTimeout);
      autosaveTimeout = setTimeout(saveFormData, AUTOSAVE_DELAY);
    }

    function newReport() {
      if (confirm('Are you sure you want to start a new report? This will clear all current data.')) {
        localStorage.removeItem('repairDashboardData');
        
        document.querySelectorAll('input[type="number"], input[type="text"], input[type="date"], textarea').forEach(input => {
          input.value = '';
        });
        
        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
          checkbox.checked = false;
        });
        
        document.getElementById('reportText').innerHTML = '';
        
        const indicator = document.getElementById('autosaveIndicator');
        indicator.textContent = 'New report started';
        indicator.style.color = 'var(--warning)';
        
        setTimeout(() => {
          indicator.textContent = 'Auto-save enabled - Your work is saved automatically';
          indicator.style.color = 'var(--accent)';
        }, 2000);
      }
    }

    // Attach auto-save to all form inputs
    document.addEventListener('DOMContentLoaded', () => {
      loadTheme();
      loadFormData();
      
      document.querySelectorAll('input, textarea').forEach(element => {
        element.addEventListener('input', autoSave);
        element.addEventListener('change', autoSave);
      });
    });

    function toggleExclusive(checkbox) {
      const checkboxes = document.querySelectorAll('input[name="creator"]');
      checkboxes.forEach(cb => {
        if (cb !== checkbox) cb.checked = false;
      });
    }

    function flagIfLow(value, total, label) {
      const ratio = total > 0 ? value / total : 0;
      const formatted = `${value}/${total} ${label}`;
      return ratio >= 0.05
        ? `<span style="color: var(--danger); font-weight: bold;">${formatted}</span>`
        : formatted;
    }

    function generateReport() {
      const today = new Date().toLocaleDateString("en-ZA");
      const autobodyName = document.getElementById('autobodyName').value.trim();
      let submissionText = '';
      const showLastSubmitted = document.getElementById('chkLastSubmitted').checked;
      const lastSubmittedDate = document.getElementById('lastSubmittedDate').value;

      if (showLastSubmitted && lastSubmittedDate) {
        const formattedDate = new Date(lastSubmittedDate).toLocaleDateString("en-ZA");
        submissionText = ` - Data last submitted ${formattedDate}`;
      }
      
      const completed2023 = +document.getElementById('completed2023').value;
      const completed2022 = +document.getElementById('completed2022').value;
      const openLong = +document.getElementById('openLong').value;
      const writeOffs = +document.getElementById('writeOffs').value;
      const pp2025 = +document.getElementById('pp2025').value;
      const pp2024 = +document.getElementById('pp2024').value;
      const tspRaw = +document.getElementById('tsp').value || 0;
      const tspFormatted = 'R ' + tspRaw.toLocaleString("en-ZA", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).replace(/,/g, ' ');
      const invalidJobs = +document.getElementById('invalidJobs').value;
      const writeOffsUnder40k = +document.getElementById('writeOffsUnder40k').value;

      const chkAggregateMake = document.getElementById('chkAggregateMake').checked;
      const chkFullBrandData = document.getElementById('chkFullBrandData').checked;
      const chkAggregateText = document.getElementById('chkAggregateText').checked;
      const aggregateTextBrands = document.getElementById('aggregateTextBrands').value.trim();
      const aggregateMakeOptions = Array.from(document.querySelectorAll('input[name="aggregateMakeOption"]:checked')).map(cb => cb.value);
      const makeClause = aggregateMakeOptions.length ? ` (${aggregateMakeOptions.join(' & ')})` : '';
      const chkInsurerName = document.getElementById('chkInsurerName').checked;

      const missstart = +document.getElementById('missstart').value;
      const compldatemiss = +document.getElementById('compldatemiss').value;
      const make = +document.getElementById('make').value;
      const validModel = +document.getElementById('validModel').value;
      const hasRegno = +document.getElementById('hasRegno').value;
      const missingVIN = +document.getElementById('missingVIN').value;
      const missReg = +document.getElementById('missReg').value;
      const missRegActive = +document.getElementById('missRegActive').value;
      const missRegUnknown = +document.getElementById('missRegUnknownWarranty').value;
      const mileage = +document.getElementById('mileage').value;
      const mileageActive = +document.getElementById('mileageActive').value;
      const ownerName = +document.getElementById('ownerName').value;
      const ownerTel = +document.getElementById('ownerTel').value;
      const fullQuote = +document.getElementById('fullQuote').value;

      const partDescription = +document.getElementById('partDescription').value;
      const missingSupplier = +document.getElementById('missingSupplier').value;
      const spotSample = +document.getElementById('spotSample').value;
      const flaggedParts = +document.getElementById('flaggedParts').value;
      const ppp = +document.getElementById('ppp').value;

      const approved2025 = +document.getElementById('approved2025').value;
      const approved2024 = +document.getElementById('approved2024').value;
      const approvedActive = +document.getElementById('approvedActive').value;
      const completed2025 = +document.getElementById('completed2025').value;
      const completed2024 = +document.getElementById('completed2024').value;
      const exclusive2024 = +document.getElementById('exclusive2024').value;
      const activeRepairs = +document.getElementById('activeRepairs').value;

      const completedTotal = approved2025 + approved2024;
      const repairTotal = approved2025 + approved2024 + approvedActive;
      const allTotal = completed2025 + exclusive2024 + activeRepairs;
      const summaryParts = [];

      let pp2025Jobs = [];
      const ppSpotCheckJobsRaw = document.getElementById('pp2025JobsInput')?.value.trim();
      const ppSpotCheckJobs = ppSpotCheckJobsRaw
        ? Array.from(ppSpotCheckJobsRaw.matchAll(/(\d+)\s*[-‚Äì]\s*.*?\s*[-‚Äì]\s*\d{2}\/\d{2}\/\d{4}/g)).map(match => match[1])
        : [];
      const rawInput = document.getElementById('pp2025JobsInput').value.trim();
      const lines = rawInput.split(',').map(line => line.trim()).filter(Boolean);

      pp2025Jobs = lines.map(line => {
        const match = line.match(/^(\d+)\s*-\s*([\w\s]+)\s*-\s*(\d{2}\/\d{2}\/\d{4})$/);
        if (!match) return null;
        const [_, jobId, brand, date] = match;
        return { jobId, brand, date };
      }).filter(Boolean);

      const autobodyPrefix = autobodyName ? `${autobodyName} - ` : '';
      
      summaryParts.push(
        `${autobodyPrefix}${today}${submissionText} - Active (${activeRepairs}); Completed 2022(${completed2022}), 2023(${completed2023}), 2024(${completed2024}), 2025(${completed2025}); ` +
        `Write-offs(${writeOffs}). PP 2024(${pp2024}/${completed2024}) & PP 2025(${pp2025}/${completed2025}); ` +
        `TSP(${tspFormatted}). Invalid Jobs(${invalidJobs}).`
      );

      if (openLong) {
        const openLongApproved = +document.getElementById('openLongApproved').value;
        summaryParts.push(`There are ${openLong}/${activeRepairs} repairs that have been open for more than 100 days (${openLongApproved}/${openLong} are for approved brands).`);
      }

      if (chkAggregateMake) {
        summaryParts.push(`They are submitting aggregate data${makeClause} Make.`);
      }
      if (chkFullBrandData) {
        summaryParts.push(`They are submitting full data for all brands they hold approval with.`);
      }
      if (chkAggregateText && aggregateTextBrands) {
        summaryParts.push(`There are some (${aggregateTextBrands}) repairs where we are receiving aggregate data.`);
      }
      if (chkInsurerName) {
        summaryParts.push("They are not submitting Insurer name.");
      }

      if (writeOffsUnder40k) {
        summaryParts.push(`There are ${writeOffsUnder40k}/${writeOffs} write-offs with repair values under R 40 000.00.`);
      }

      const dateErrors = [];

      if (missstart) dateErrors.push(`${flagIfLow(missstart, repairTotal, "missing start date")}`);
      if (compldatemiss) dateErrors.push(`${flagIfLow(compldatemiss, repairTotal, "missing completion date")}`);
      if (make) dateErrors.push(`${make} repairs are missing make`);
      if (validModel) {
        const selectedModels = Array.from(document.querySelectorAll('input[name="validModels"]:checked')).map(cb => cb.value);
        const includeClause = selectedModels.length ? ' (including ' + selectedModels.join(', ').replace(/, ([^,]*)$/, ' & $1') + ')' : '';
        dateErrors.push(`${flagIfLow(validModel, repairTotal, "have invalid model")}${includeClause}`);
      }
      if (hasRegno) dateErrors.push(`${flagIfLow(hasRegno, repairTotal, "missing registration no")}`);
      if (missingVIN) dateErrors.push(`${flagIfLow(missingVIN, repairTotal, "missing VIN")}`);
      if (missReg) dateErrors.push(`${flagIfLow(missReg, repairTotal, "missing year of reg")} (${missRegActive}/${approvedActive} are active, ${missRegUnknown}/${missReg} have unknown warranty status)`);
      if (mileage) dateErrors.push(`${flagIfLow(mileage, repairTotal, "missing mileage")} (${mileageActive}/${approvedActive} are active)`);
      if (ownerName) dateErrors.push(`${flagIfLow(ownerName, repairTotal, "missing owner name")}`);
      if (ownerTel) dateErrors.push(`${flagIfLow(ownerTel, repairTotal, "missing owner telephone")}`);
      if (fullQuote) dateErrors.push(`${flagIfLow(fullQuote, repairTotal, "missing full quote details")}`);

      if (dateErrors.length) {
        summaryParts.push(dateErrors.join('; ') + '.');
      }

      if (partDescription) {
        summaryParts.push(`${flagIfLow(partDescription, completedTotal, "completed repairs missing part description")}.`);
      }

      if (missingSupplier) {
        summaryParts.push(`${flagIfLow(missingSupplier, completedTotal, "missing supplier name")}.`);
      }

      const totalPartFlags = partDescription + missingSupplier;
      if (spotSample > 0) {
        const proportion = flaggedParts / spotSample;
        let estimateFlagged = Math.round(proportion * totalPartFlags);
        estimateFlagged = Math.min(estimateFlagged, totalPartFlags);

        let spotCheckText = `I spot-checked ${totalPartFlags}/${spotSample} `;
        
        if (totalPartFlags === spotSample) {
          spotCheckText += '<span style="color: var(--danger); font-weight: bold;">all have been flagged.</span>';
        } else {
          const ratio = estimateFlagged / totalPartFlags;
          const likelyText = ratio >= 0.05 
            ? `<span style="color: var(--danger); font-weight: bold;">therefore it is likely that ${estimateFlagged}/${totalPartFlags} are flagged for parts.</span>`
            : `therefore it is likely that ${estimateFlagged}/${totalPartFlags} are flagged for parts.`;
          spotCheckText += likelyText;
        }
        
        summaryParts.push(spotCheckText);
      }

      if (ppp) {
        summaryParts.push(`${flagIfLow(ppp, allTotal, "total repairs missing part purchase price")}.`);
      }

      if (ppSpotCheckJobs.length > 0) {
        const spotCheckTotal = 10;
        const flaggedManual = +document.getElementById('ppSpotCheckFlagged')?.value || 0;

        const ppSpotCheckDetails = pp2025Jobs
          .filter(job => ppSpotCheckJobs.includes(job.jobId))
          .map(job => `${job.jobId} - ${job.brand} - ${job.date}`);

        summaryParts.push(
          `I spot-checked ${spotCheckTotal} High Value In-Warranty repairs with R0.00 and found ${flaggedManual} repairs where we are receiving Part Description/Job Card Price and/or Part Number. ` +
          `Jobs affected: ${ppSpotCheckDetails.join(', ')}.`
        );
      }

      const disclaimerBrands = [];

      ['ford', 'gwmhaval', 'honda', 'hyundai', 'isuzu', 'jac', 'mahindra', 'mitsubishi', 'suzuki', 'stellantis'].forEach(idPrefix => {
        const txt = document.getElementById(idPrefix + 'Disclaimer')?.value.trim();
        const checkbox = document.getElementById(idPrefix + 'DisclaimerCheck');
        const checked = checkbox ? checkbox.checked : false;
        
        let title = idPrefix;
        if (idPrefix === 'gwmhaval') title = 'GWM & Haval';
        else if (idPrefix === 'stellantis') title = 'Stellantis';
        else title = idPrefix.charAt(0).toUpperCase() + idPrefix.slice(1);

        if (checked) {
          disclaimerBrands.push(title);
        }
      });

      if (disclaimerBrands.length) {
        const brandList = disclaimerBrands.join(', ').replace(/, ([^,]*)$/, ' & $1');
        let flagText;
        if (disclaimerBrands.includes('Stellantis')) {
          flagText = `There are no recent In-Warranty ${brandList.replace('Stellantis', '')} repairs where non-OEM parts were fitted and no recent Stellantis categorization forms.`.replace(', &', '');
        } else {
          flagText = `There are no recent In-Warranty ${brandList} repairs where non-OEM parts were fitted.`;
        }
        summaryParts.push(flagText);
      }

      const additionalNotes = document.getElementById('additionalNotes')?.value.trim();
      const creator = document.querySelector('input[name="creator"]:checked')?.value || '';
      
      if (additionalNotes) {
        if (creator) {
          summaryParts.push(`Additional Notes: ${additionalNotes} (${creator})`);
        } else {
          summaryParts.push(`Additional Notes: ${additionalNotes}`);
        }
      } else if (creator) {
        summaryParts.push(`(${creator})`);
      }

      let html = `<p>${summaryParts.join(' ')}</p>`;

      document.getElementById('reportText').innerHTML = html;
    }
  </script>

</body>
</html>
